name: Facility Monitor (Staging / Test)

on:
  workflow_dispatch:
    inputs:
      facility:
        description: "Facility name to test (optional)"
        required: false
      force:
        description: "Force run outside JST window (0/1)"
        required: false
        default: "1"
  pull_request:
    branches: [ "main" ]
    paths:
      - "monitor.py"
      - "config.json"
      - ".github/workflows/**"
      - "requirements.txt"

permissions:
  contents: read
  actions: read
  checks: read

env:
  PYTHONUNBUFFERED: "1"
  OUTPUT_DIR: snapshots-test
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
  MONITOR_START_HOUR: "0"
  MONITOR_END_HOUR: "23"
  MONITOR_END_MINUTE: "59"
  GRACE_MS: "600"
  DISCORD_FORCE_TEXT: "1"

jobs:
  test:
    environment: staging
    runs-on: ubuntu-latest

    if: startsWith(github.ref, 'refs/heads/feature/') || github.event_name == 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        facility: ${{ fromJSON(inputs.facility || '["南浦和コミュニティセンター","浦和駒場体育館"]') }}

    concurrency:
      group: monitor-staging-${{ matrix.facility }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Prepare Playwright cache dir
        run: mkdir -p ~/.cache/ms-playwright

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          python - <<'PY'
          import subprocess, sys
          try:
            import playwright
            print("[INFO] playwright present.")
          except Exception:
            print("[INFO] Installing playwright==1.46.0 ...")
            subprocess.check_call([sys.executable, "-m", "pip", "install", "playwright==1.46.0"])
          PY
          python -m playwright install chromium

      - name: Validate config.json
        run: python -m json.tool config.json > /dev/null

      - name: Run monitor (staging)
        env:
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
          BASE_URL: ${{ secrets.BASE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_MENTION_USER_ID: ${{ secrets.DISCORD_MENTION_USER_ID }}
          DISCORD_FORCE_TEXT: ${{ env.DISCORD_FORCE_TEXT }}
          MONITOR_FORCE: ${{ inputs.force || '1' }}
          MONITOR_START_HOUR: ${{ env.MONITOR_START_HOUR }}
          MONITOR_END_HOUR: ${{ env.MONITOR_END_HOUR }}
          MONITOR_END_MINUTE: ${{ env.MONITOR_END_MINUTE }}
          GRACE_MS: ${{ env.GRACE_MS }}
        run: |
          echo "[INFO] STAGING run for: ${{ matrix.facility }}"
          python -u monitor.py --facility "${{ matrix.facility }}"

      - name: Upload test artifacts (snapshots + logs)
        uses: actions/upload-artifact@v4
        with:
          name: staging-${{ matrix.facility }}-${{ github.run_id }}
          path: |
            ${{ env.OUTPUT_DIR }}/
            **/*.log
          if-no-files-found: warn
