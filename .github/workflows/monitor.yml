name: Facility Availability Monitor

on:
  schedule:
    - cron: "*/5 * * * *"   # 5åˆ†ãŠã
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    # ğŸ¯ ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒ‡å®šï¼šã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼
    container:
      image: mcr.microsoft.com/playwright/python:v1.46.0-jammy

    steps:
      - name: Restrict to JST 05:00â€“24:00
        run: |
          HOUR_JST=$(TZ=Asia/Tokyo date +%H)
          echo "Current JST hour: ${HOUR_JST}"
          if [ "$HOUR_JST" -ge 5 ] && [ "$HOUR_JST" -le 23 ]; then
            echo "Within monitoring window. Continue."
          else
            echo "Outside monitoring window. Skip."
            exit 0
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ¯ Playwrightã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä¸è¦ï¼
      # Browserã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚ä¸è¦ï¼
      # install-deps ã‚‚ä¸è¦ï¼

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run monitor
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "[INFO] Starting monitor.py ..."
          python -u monitor.py
          echo "[INFO] monitor.py finished."

      - name: Show snapshot files
        run: |
          echo "----- snapshots tree -----"
          find snapshots -maxdepth 3 -type f -print || true
          echo "--------------------------"

      - name: Commit & Push snapshot updates
        run: |
          set -e
          if [[ -n $(git status --porcelain snapshots/) ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add snapshots/
            git commit -m "chore: update snapshots ($(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S JST'))"
            git push
          fi
