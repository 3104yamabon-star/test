name: Facility Availability Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # 5分おき
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Restrict to JST 05:00–24:00
        run: |
          HOUR_JST=$(TZ=Asia/Tokyo date +%H)
          echo "Current JST hour: ${HOUR_JST}"
          if [ "$HOUR_JST" -ge 5 ] && [ "$HOUR_JST" -le 23 ]; then
            echo "Within monitoring window (05:00–24:00 JST). Continue."
          else
            echo "Outside monitoring window. Skip."
            exit 0
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ms-playwright-${{ runner.os }}-chromium-1.46.0
          restore-keys: |
            ms-playwright-${{ runner.os }}-chromium-

      - name: Install Playwright (chromium only)
        run: |
          python -m playwright install-deps
          python -m playwright install chromium

      - name: Run monitor (with debug logs)
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PYTHONUNBUFFERED: "1"        # 標準出力のバッファリングを無効化
        run: |
          echo "[INFO] Starting monitor.py ..."
          python -u monitor.py          # -u でアンバッファ実行（DEBUGログを確実に出す）
          echo "[INFO] monitor.py finished."

      - name: Show snapshot files (debug)
        run: |
          echo "----- snapshots tree -----"
          find snapshots -maxdepth 3 -type f -print || true
          echo "--------------------------"

      - name: Commit & Push snapshot updates
        run: |
          set -e
          if [[ -n $(git status --porcelain snapshots/) ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add snapshots/
            git commit -m "chore: update snapshots ($(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S JST'))"
            git push
          fi
``
